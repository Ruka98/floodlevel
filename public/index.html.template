<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>Sri Lanka Flood Potential Map</title>
  <style>
    /* RESET & BASE */
    html, body { 
      height: 100%; 
      margin: 0; 
      padding: 0; 
      font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
      overscroll-behavior: none;
      overflow: hidden;
    }

    body {
      display: flex;
      flex-direction: column;
      background: #f5f5f5;
    }

    /* TOPBAR STYLING */
    #topbar {
      flex: 0 0 auto;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 12px 16px;
      background: #fff;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      z-index: 10;
      position: relative;
    }

    /* MAP CONTAINER */
    #map {
      flex: 1 1 auto;
      width: 100%;
      background: #e5e3df;
    }

    /* BUTTONS */
    .btn {
      padding: 10px 14px;
      border-radius: 8px;
      border: 1px solid #ddd;
      cursor: pointer;
      background: #fff;
      transition: all 0.2s;
      font-size: 14px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      touch-action: manipulation;
      white-space: nowrap;
    }
    .btn:hover, .btn:active { 
      background: #f0f0f0; 
      transform: translateY(-1px);
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    }
    .btn:disabled { 
      opacity: 0.5; 
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    /* TITLE */
    .title-text { 
      font-weight: 600; 
      font-size: 16px; 
      color: #333;
      margin-right: auto;
    }
    .api-note { 
      font-size: 11px; 
      color: #777; 
      margin-left: 10px;
    }

    /* MOBILE CONTROLS PANEL */
    #mobile-controls {
      position: absolute;
      bottom: 20px;
      right: 20px;
      display: flex;
      flex-direction: column;
      gap: 10px;
      z-index: 5;
    }

    .mobile-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: #fff;
      border: none;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      cursor: pointer;
      transition: all 0.2s;
      touch-action: manipulation;
    }

    .mobile-btn:active {
      transform: scale(0.95);
      box-shadow: 0 1px 5px rgba(0,0,0,0.2);
    }

    /* LEGEND */
    #legend {
      position: absolute;
      bottom: 20px;
      left: 20px;
      background: rgba(255, 255, 255, 0.9);
      padding: 12px 16px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      font-size: 12px;
      z-index: 5;
      max-width: 180px;
      backdrop-filter: blur(5px);
    }

    .legend-title {
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
    }

    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 4px;
    }

    .legend-color {
      width: 16px;
      height: 16px;
      margin-right: 8px;
      border-radius: 2px;
    }

    /* MOBILE MENU (Reduced) */
    #mobile-menu {
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.95);
      z-index: 20;
      display: none;
      flex-direction: column;
      padding: 20px;
      overflow-y: auto;
      backdrop-filter: blur(5px);
    }

    .menu-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #eee;
    }

    .menu-title {
      font-size: 18px;
      font-weight: 600;
      color: #333;
    }

    .close-menu {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
    }

    /* --- MOBILE RESPONSIVE TWEAKS --- */
    @media (max-width: 768px) {
      #topbar {
        padding: 10px 12px;
        flex-wrap: wrap;
        gap: 8px;
      }

      .title-text { 
        font-size: 14px; 
        width: 100%;
        text-align: center;
        margin-bottom: 5px;
      }

      #btnFit, #btnLocate, #btnDownload, #btnMenu {
        flex: 1;
        height: 40px;
        font-size: 13px;
      }

      .api-note { display: none; }
      
      #legend {
        bottom: 90px;
        left: 10px;
        right: 10px;
        max-width: none;
      }
      
      #mobile-controls {
        bottom: 20px;
        right: 10px;
      }
    }

    @media (min-width: 769px) {
      #btnMenu { display: none; }
      .mobile-btn { display: none; }
    }
  </style>
</head>
<body>

  <div id="topbar">
    <div class="title-text">Sri Lanka Flood Potential Map</div>
    
    <button id="btnFit" class="btn">Fit Map</button>
    <button id="btnLocate" class="btn">üìç Me</button>
    <button id="btnDownload" class="btn" disabled>‚¨á GeoJSON</button>
    <button id="btnMenu" class="btn">‚ò∞ Menu</button>
    
    <span class="api-note">SRTM 30m DEM</span>
  </div>

  <div id="map"></div>

  <div id="mobile-controls">
    <button id="btnMobileFit" class="mobile-btn" title="Fit to data">‚§¢</button>
    <button id="btnMobileLocate" class="mobile-btn" title="My location">üìç</button>
    <button id="btnMobileLegend" class="mobile-btn" title="Toggle legend">üìä</button>
  </div>

  <div id="legend">
    <div class="legend-title">Legend</div>
    <div class="legend-item">
      <div class="legend-color" style="background-color: #4285f4; opacity: 0.5;"></div>
      <span>Flood Potential Area</span>
    </div>
  </div>

  <div id="mobile-menu">
    <div class="menu-header">
      <div class="menu-title">Options</div>
      <button class="close-menu">√ó</button>
    </div>
    
    <div class="menu-section">
      <div style="font-weight: 600; margin-bottom: 10px; color: #333;">Data Export</div>
      <button id="mobileDownload" class="btn" style="width: 100%; margin-bottom: 10px;" disabled>Download Shapefile (GeoJSON)</button>
      <div style="font-size: 12px; color: #777; text-align: center; margin-top: 20px;">
        Source: SRTM 30m DEM<br>
        Visual: 50% Opacity, No Boundary
      </div>
    </div>
  </div>

  <script src="https://maps.googleapis.com/maps/api/js?key=__GOOGLE_MAPS_API_KEY__&libraries=places"></script>

  <script>
    let map, geojsonLayer, featureCollection;
    const mapEl = document.getElementById('map');
    const btnDownloadEl = document.getElementById('btnDownload');
    
    // Mobile elements
    const mobileMenuEl = document.getElementById('mobile-menu');
    const btnMenuEl = document.getElementById('btnMenu');
    const closeMenuEl = document.querySelector('.close-menu');
    const mobileDownloadEl = document.getElementById('mobileDownload');
    const btnMobileFitEl = document.getElementById('btnMobileFit');
    const btnMobileLocateEl = document.getElementById('btnMobileLocate');
    const btnMobileLegendEl = document.getElementById('btnMobileLegend');
    const legendEl = document.getElementById('legend');

    // Default Style Values
    const FIXED_OPACITY = 0.5; // Fixed at 50%
    const FLOOD_COLOR = '#4285f4'; // Uniform Blue
    const STROKE_WEIGHT = 0; // No boundary lines

    // Center of Sri Lanka for fallback
    const SRI_LANKA_CENTER = { lat: 7.8731, lng: 80.7718 };

    function initMap() {
      // Initialize map
      map = new google.maps.Map(mapEl, {
        center: SRI_LANKA_CENTER,
        zoom: 7,
        mapTypeControl: true,
        mapTypeControlOptions: { 
          position: google.maps.ControlPosition.LEFT_BOTTOM,
          style: google.maps.MapTypeControlStyle.DROPDOWN_MENU
        },
        streetViewControl: false,
        fullscreenControl: false,
        zoomControl: true,
        zoomControlOptions: {
          position: google.maps.ControlPosition.RIGHT_BOTTOM
        }
      });

      // Load Data
      fetch('/static/5m.geojson') 
        .then(r => { 
          if (!r.ok) throw new Error('Failed to load 5m.geojson'); 
          return r.json(); 
        })
        .then(data => {
          featureCollection = data;
          addGeoJSONToMap(data);
          btnDownloadEl.disabled = false;
          mobileDownloadEl.disabled = false;
        })
        .catch(err => {
          console.error(err);
          alert("Error loading map data.");
        });

      // Event Listeners
      document.getElementById('btnFit').onclick = () => fitToGeoJSON();
      document.getElementById('btnLocate').onclick = () => locateUser();
      btnDownloadEl.onclick = () => downloadGeoJSON();
      
      // Mobile event listeners
      btnMenuEl.onclick = () => mobileMenuEl.style.display = 'flex';
      closeMenuEl.onclick = () => mobileMenuEl.style.display = 'none';
      
      mobileDownloadEl.onclick = () => downloadGeoJSON();
      btnMobileFitEl.onclick = () => fitToGeoJSON();
      btnMobileLocateEl.onclick = () => locateUser();
      btnMobileLegendEl.onclick = () => {
        legendEl.style.display = legendEl.style.display === 'none' ? 'block' : 'none';
      };

      map.addListener('click', () => {
        if (currentInfoWindow) currentInfoWindow.close();
      });
      
      // Close mobile menu when clicking outside
      mobileMenuEl.addEventListener('click', (e) => {
        if (e.target === mobileMenuEl) {
          mobileMenuEl.style.display = 'none';
        }
      });
    }

    // Simplified style function: Fixed Color, 50% Opacity, 0 Border
    function getGeoJSONStyle(feature) {
        return {
          fillColor: FLOOD_COLOR,
          strokeWeight: STROKE_WEIGHT, // 0px boundary
          fillOpacity: FIXED_OPACITY
        };
    }

    function downloadGeoJSON() {
      if (!featureCollection) return alert('Data not loaded yet.');
      const dataStr = JSON.stringify(featureCollection, null, 2);
      const blob = new Blob([dataStr], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      
      const link = document.createElement('a');
      link.href = url;
      link.download = 'srilanka_flood_data.geojson';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(url);
    }

    let currentInfoWindow = null;
    function addGeoJSONToMap(data) {
      geojsonLayer = new google.maps.Data({ map: map, zIndex: 1 });
      geojsonLayer.addGeoJson(data);
      geojsonLayer.setStyle(feature => getGeoJSONStyle(feature));
      
      geojsonLayer.addListener('click', ev => {
        const props = getProperties(ev.feature);
        const content = buildInfoHtml(props);
        if (currentInfoWindow) currentInfoWindow.close();
        currentInfoWindow = new google.maps.InfoWindow({
          content,
          position: ev.latLng,
          maxWidth: 300
        });
        currentInfoWindow.open(map);
      });
      fitToGeoJSON();
    }

    function getProperties(feature) {
      const p = {};
      if (feature && feature.forEachProperty) {
        feature.forEachProperty((value, key) => p[key] = value);
      } else if (feature && feature.getProperty) {
        return { id: feature.getId() };
      }
      return p;
    }

    function formatKey(key) {
      return key.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
    }

    function buildInfoHtml(props) {
      let html = '<div style="font-family:sans-serif; font-size:13px; max-width:260px; line-height:1.4;">';
      if (!props || Object.keys(props).length === 0) html += '<em>No specific property data.</em>';
      else {
        html += '<h5 style="margin:0 0 8px; color: #1F78B4; font-size:15px;">Area Details</h5>';
        html += '<table style="width:100%; border-collapse: collapse;">';
        for (const k of Object.keys(props)) {
          if (k === 'id' || k.startsWith('_')) continue; 
          html += '<tr style="border-bottom:1px solid #eee;">' +
                  '<td style="font-weight:600; padding:4px 2px; vertical-align:top; color:#555;">' + escapeHtml(formatKey(k)) + '</td>' +
                  '<td style="padding:4px 2px; vertical-align:top; text-align:right;">' + escapeHtml(String(props[k])) + '</td></tr>';
        }
        html += '</table>';
      }
      html += '</div>';
      return html;
    }

    function escapeHtml(s){ 
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    function fitToGeoJSON() {
      if (!featureCollection) return;
      const bounds = new google.maps.LatLngBounds();
      const ext = featureCollection.features;
      if (!ext || ext.length === 0) {
        map.setCenter(SRI_LANKA_CENTER);
        map.setZoom(7);
        return;
      }
      ext.forEach(f => {
        addCoordsToBounds(f.geometry, bounds);
      });
      map.fitBounds(bounds);
    }

    function addCoordsToBounds(geom, bounds) {
      if (!geom) return;
      const type = geom.type;
      if (type === 'Point') {
        bounds.extend({lat: geom.coordinates[1], lng: geom.coordinates[0]});
      } else if (type === 'MultiPoint' || type === 'LineString') {
        geom.coordinates.forEach(c => bounds.extend({lat: c[1], lng: c[0]}));
      } else if (type === 'Polygon' || type === 'MultiLineString') {
        geom.coordinates.forEach(ring => ring.forEach(c => bounds.extend({lat:c[1], lng:c[0]})));
      } else if (type === 'MultiPolygon') {
        geom.coordinates.forEach(poly => poly.forEach(ring => ring.forEach(c => bounds.extend({lat:c[1], lng:c[0]}))));
      } else if (type === 'GeometryCollection') {
        geom.geometries.forEach(g => addCoordsToBounds(g, bounds));
      }
    }

    function locateUser() {
      if (!navigator.geolocation) return alert('Geolocation not supported.');
      navigator.geolocation.getCurrentPosition(pos => {
        const p = { lat: pos.coords.latitude, lng: pos.coords.longitude };
        map.setCenter(p);
        map.setZoom(14);
        new google.maps.Marker({ 
          map, 
          position: p, 
          title: 'You are here',
          icon: {
            url: 'data:image/svg+xml;charset=UTF-8,' + encodeURIComponent(`
              <svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg">
                <circle cx="10" cy="10" r="8" fill="#4285f4" stroke="#fff" stroke-width="2"/>
              </svg>
            `),
            scaledSize: new google.maps.Size(20, 20),
            anchor: new google.maps.Point(10, 10)
          }
        });
      }, err => {
        alert('Geolocation error: ' + (err.message || err.code));
      }, { enableHighAccuracy: true, timeout: 8000 });
    }

    window.onload = initMap;
  </script>
</body>
</html>